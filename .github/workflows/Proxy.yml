name: ☢️ Proxy Tự động 3m

on:
  # Kích hoạt một job mới mỗi 6 giờ một lần
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  long-running-update:
    runs-on: ubuntu-latest
    # Dừng job sau 355 phút để tránh bị GitHub ngắt đột ngột
    timeout-minutes: 355
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cấu hình Git để có thể commit
      - name: Cấu hình Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # Vòng lặp chính để cập nhật mỗi 3 phút
      - name: Bắt đầu vòng lặp cập nhật
        run: |
          while true; do
            echo "-------------------------------------------"
            echo "Bắt đầu chu kỳ mới lúc: $(date)"
            
            # Tải proxy mới
            echo "Đang tải proxy..."
            curl -s -o proxy.txt "https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&proxy_format=protocolipport&format=text"
            
            # Chỉ commit và push nếu file proxy.txt thực sự có thay đổi
            if ! git diff --quiet proxy.txt; then
              echo "Phát hiện thay đổi. Đang commit..."
              git add proxy.txt
              git commit -m "CI: Cập nhật danh sách proxy tự động (vòng lặp)"
              # Cố gắng đẩy lên, nếu thất bại (do có commit khác) thì thử lại ở lần sau
              git push || echo "Đẩy code thất bại, sẽ thử lại sau 3 phút."
            else
              echo "Không có thay đổi, bỏ qua commit."
            fi
            
            # Chờ 3 phút (180 giây)
            echo "Đã xong. Chờ 180 giây..."
            sleep 180
          done
